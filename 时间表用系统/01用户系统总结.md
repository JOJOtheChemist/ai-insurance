# 时间表项目用户系统及登录实现总结

## 1. 登录页面实现 (Frontend - React)
*   **位置**: `frontend/src/pages/LoginPage/LoginPage.jsx`
*   **核心功能**:
    *   **多模式支持**: 包含“登录”、“注册”、“忘记密码”三种模式，通过 `mode` 状态切换。
    *   **表单字段**: 用户名/邮箱、密码、确认密码（注册模式）、验证码（重置模式）、**邀请码**（注册/重置模式必填）。
    *   **访客登录**: 支持 `handleGuestLogin` 功能。
    *   **UI 设计**: 采用现代风格，包含动态背景圆圈（`bg-circle`）和玻璃拟态效果。
    *   **密码处理**: 前端负责密码输入，通过 POST 请求提交给后端。

## 2. 用户系统后端逻辑 (Backend - FastAPI)
*   **主体框架**: 基于 FastAPI 的 Python 后端，采用模块化设计。
*   **位置**: `backend/routers/users.py`
*   **认证逻辑**:
    *   **认证逻辑**:
    *   **接口**: 主攻 `/api/v1/users/auth/login` 和 `/api/v1/users/auth/register`。
    *   **邀请码校验**: 注册和重置密码均需通过邀请码验证。系统设有专门的 `invite_codes` 路由用于生成和管理这些代码（格式如 `INV-XXXX`）。
    *   **密码校验**: 同时支持 `bcrypt` 哈希校验和明文校验（可能用于遗留数据或调试）。
    *   **Session/Token**: 登录成功后返回访问令牌（AccessToken），用于后续身份验证。
    *   **日志记录**: 后端详细记录了登录、注册的 IP 和响应状态。

## 3. PostgreSQL 表结构 (Database - Models)
主要通过两个 SQLAlchemy 模型定义：

### `users` 表 (核心用户信息)
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | BigInteger | 主键 |
| `username` | String(50) | 用户名 (唯一, 索引) |
| `email` | String(100) | 电子邮箱 (唯一, 索引) |
| `password_hash` | String(255) | 密码哈希 (bcrypt 或明文) |
| `invite_code` | String(50) | 注册时使用的邀请码 |
| `is_active` | Boolean | 是否激活 (默认 True) |
| `is_superuser` | Boolean | 是否为超级管理员 |
| `create_time` | DateTime | 创建时间 (自动生成) |
| `update_time` | DateTime | 更新时间 (自动更新) |

### `user_profile` 表 (用户偏好与设置)
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | BigInteger | 主键 |
| `user_id` | BigInteger | 关联用户 ID (唯一, 索引) |
| `profile_visibility` | String(20) | 资料可见性 (public/friends/private) |
| `allow_follow` | SmallInteger | 是否允许关注 |
| `show_study_stats` | SmallInteger | 是否显示学习统计 |
| `email_notification` | SmallInteger | 邮件通知开关 |
| `push_notification` | SmallInteger | 推送通知开关 |
| `theme` | String(20) | 主题颜色 (light/dark) |
| `language` | String(10) | 语言设置 (zh-CN) |
| `timezone` | String(50) | 时区 (Asia/Shanghai) |
| `create_time` | DateTime | 创建时间 |
| `update_time` | DateTime | 更新时间 |

### `invite_codes` 表 (授权管理)
| 字段名 | 类型 | 说明 |
| :--- | :--- | :--- |
| `id` | BigInteger | 主键 |
| `code` | String(50) | 唯一邀请码 (例如: `INV-XXXX`) (唯一, 索引) |
| `is_used` | Boolean | 是否已使用 (默认 False) |
| `used_by` | BigInteger | 使用该码的用户 ID (外键, 索引) |
| `created_at` | DateTime | 生成时间 |
| `used_at` | DateTime | 使用时间 |

## 4. 邀请码生成方式
*   **算法设计**: 采用加密安全的随机生成方式。
*   **代码实现**: 位于 `backend/routers/invite_codes.py` 中的 `generate_random_invite_code` 函数。
    *   **字符集**: 大写字母 (A-Z) + 数字 (0-9)。
    *   **默认格式**: `{PREFIX}-{RANDOM_STRING}` (前缀默认为 `INV`，随机部分长度默认为 12)。
    *   **安全性**: 使用 Python `secrets` 模块（相比 `random` 模块更具不可预测性）。
*   **管理接口**:
    *   `POST /api/v1/invite-codes/generate`: 批量生成邀请码 (支持自定义前缀和长度)。
    *   `GET /api/v1/invite-codes/unused`: 获取当前待发放的未使用邀请码。

## 结论
该项目是一个标准的现代化 React + FastAPI 应用。用户系统不仅实现了基础的账号管理，还通过严谨的邀请码机制构筑了准入屏障，数据库设计在功能拆分、索引优化和安全性（哈希加密 + 安全随机数）方面表现出色。
