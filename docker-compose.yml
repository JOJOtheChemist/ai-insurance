version: '3.8'

services:
  # ==========================================
  # 1. PostgreSQL 数据库
  # ==========================================
  postgres:
    image: postgres:15-alpine
    platform: linux/amd64
    container_name: insurance-postgres
    restart: unless-stopped
    ports:
      - "15432:5432" # 映射到15432避免与服务器现有PostgreSQL冲突
    volumes:
      - ./database/insurance_products_dump.sql:/docker-entrypoint-initdb.d/init.sql
      - postgres_data:/var/lib/postgresql/data
    environment:
      POSTGRES_DB: insurance_products
      POSTGRES_USER: ${POSTGRES_USER:-insurance_user}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-insurance_password_2024}
      POSTGRES_HOST_AUTH_METHOD: trust
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U insurance_user -d insurance_products" ]
      interval: 10s
      timeout: 5s
      retries: 5
    mem_limit: 512m
    cpus: 1

  # ==========================================
  # 2. 保险工具API (FastAPI + Python)
  # ==========================================
  insurance-api:
    platform: linux/amd64
    build:
      context: ./insurance-product-backend/backend
      dockerfile: Dockerfile
    image: insurance-api:latest
    container_name: insurance-api
    restart: unless-stopped
    ports:
      - "18000:8000" # 映射到18000避免冲突
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DB_HOST: postgres
      DB_NAME: insurance_products
      DB_USER: insurance_user
      DB_PASSWORD: insurance_password_2024
      DB_PORT: 5432
      PYTHONUNBUFFERED: 1
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/docs" ]
      interval: 30s
      timeout: 10s
      retries: 3
    mem_limit: 512m
    cpus: 1

  # ==========================================
  # 3. Kode SDK 后端 (Node.js + TypeScript)
  # ==========================================
  kode-backend:
    platform: linux/amd64
    build:
      context: ./kode-sdk
      dockerfile: Dockerfile
    image: kode-backend:latest
    container_name: kode-backend
    restart: unless-stopped
    ports:
      - "13001:3001" # 映射到13001避免冲突
    depends_on:
      insurance-api:
        condition: service_healthy
    environment:
      NODE_ENV: production
      PORT: 3001
      HOST: 0.0.0.0
      BACKEND_API_URL: http://insurance-api:8000
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
      ANTHROPIC_MODEL_ID: ${ANTHROPIC_MODEL_ID:-glm-4.5-air}
      ANTHROPIC_BASE_URL: ${ANTHROPIC_BASE_URL:-https://open.bigmodel.cn/api/anthropic/v1/messages}
    volumes:
      - kode_sessions:/app/.kode
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:3001/api/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    mem_limit: 768m
    cpus: 1.5

  # ==========================================
  # 4. React 前端 (Nginx + 静态文件)
  # ==========================================
  frontend:
    platform: linux/amd64
    build:
      context: ./react-app
      dockerfile: Dockerfile
    image: insurance-frontend:latest
    container_name: insurance-frontend
    restart: unless-stopped
    ports:
      - "80:80" # 映射到80端口
    depends_on:
      - kode-backend
    environment:
      VITE_BACKEND_URL: http://${SERVER_IP:-localhost}:13001
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:80" ]
      interval: 30s
      timeout: 10s
      retries: 3
    mem_limit: 128m
    cpus: 0.5

# ==========================================
# 数据卷 (持久化存储)
# ==========================================
volumes:
  postgres_data:
    name: insurance_postgres_data
  kode_sessions:
    name: insurance_kode_sessions

# ==========================================
# 网络配置 (默认桥接网络即可)
# ==========================================
networks:
  default:
    name: insurance-network
