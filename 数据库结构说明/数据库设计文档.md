# AI保典 数据库设计文档

## 数据库信息
- **数据库名称**：sure_server
- **数据库地址**：47.115.222.118:3306
- **字符集**：UTF-8

## 数据库概览

本数据库共包含 **13** 张表，主要分为以下几个模块：

1. **用户与会员管理**：user、member、member_subscription、member_subscription_record
2. **订单与支付**：order、subscription_package
3. **聊天功能**：chat_message、avatars
4. **保险产品**：insurance_product
5. **权限管理**：role、permission、role_permission
6. **文件管理**：upload_file

---

## 一、用户与会员管理模块

### 1.1 user（用户表）

用户基础信息表，存储微信登录用户的基本资料。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 用户ID |
| open_id | varchar(100) | YES | NULL | UNI | 微信openid |
| phone_number | varchar(20) | YES | NULL | UNI | 手机号 |
| nickname | varchar(50) | YES | NULL | - | 昵称 |
| avatar_url | varchar(255) | YES | NULL | - | 头像URL |
| real_name | varchar(50) | YES | NULL | - | 真实姓名 |
| id_card | varchar(20) | YES | NULL | - | 身份证号 |
| role_id | bigint | YES | 1 | - | 角色ID |
| member_level | tinyint | YES | NULL | - | 会员等级：0-普通用户 1-月度会员 2-季度会员 3-年度会员 |
| member_expire_time | datetime | YES | NULL | - | 会员到期时间 |
| create_time | datetime | YES | CURRENT_TIMESTAMP | - | 注册时间 |
| last_login_time | datetime | YES | CURRENT_TIMESTAMP | - | 最后登录时间 |
| status | tinyint | YES | 1 | - | 状态：0-禁用 1-启用 |

### 1.2 member（会员表）

会员详细信息表，存储VIP会员相关数据。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 会员ID |
| user_id | varchar(64) | NO | - | UNI | 微信用户ID |
| nickname | varchar(100) | YES | NULL | - | 用户昵称 |
| avatar | varchar(255) | YES | NULL | - | 头像URL |
| phone | varchar(20) | YES | NULL | - | 手机号 |
| member_level | int | YES | 0 | - | 会员等级 |
| total_amount | decimal(10,2) | YES | 0.00 | - | 累计充值金额 |
| balance | decimal(10,2) | YES | 0.00 | - | 账户余额 |
| is_vip | tinyint(1) | YES | 0 | - | 是否VIP会员 |
| vip_start_time | datetime | YES | NULL | - | VIP开始时间 |
| vip_end_time | datetime | YES | NULL | - | VIP结束时间 |
| create_time | datetime | YES | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | datetime | YES | CURRENT_TIMESTAMP | - | 更新时间 |

### 1.3 member_subscription（会员订阅表）

会员订阅订单记录表。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 订阅ID |
| user_id | bigint | NO | - | MUL | 用户ID |
| subscription_type | tinyint | NO | - | - | 订阅类型：1-月度会员 2-季度会员 3-年度会员 |
| price | int | NO | - | - | 价格（分） |
| order_no | varchar(64) | NO | - | UNI | 订单号 |
| pay_status | tinyint | YES | 0 | MUL | 支付状态：0-未支付 1-已支付 |
| pay_time | datetime | YES | NULL | - | 支付时间 |
| pay_method | tinyint | YES | NULL | - | 支付方式：1-支付宝 2-微信支付 |
| create_time | datetime | YES | CURRENT_TIMESTAMP | - | 创建时间 |
| start_time | datetime | YES | NULL | - | 开始时间 |
| end_time | datetime | YES | NULL | - | 结束时间 |
| refund_time | datetime | YES | NULL | - | 退款时间 |

### 1.4 member_subscription_record（会员订阅记录表）

会员订阅历史记录表。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 订阅记录ID |
| user_id | varchar(64) | NO | - | MUL | 用户ID |
| package_id | bigint | NO | - | - | 套餐ID |
| order_id | bigint | NO | - | - | 订单ID |
| start_time | datetime | NO | - | - | 开始时间 |
| end_time | datetime | NO | - | - | 结束时间 |
| status | tinyint(1) | YES | 1 | MUL | 状态:1-有效,0-过期 |
| create_time | datetime | YES | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | datetime | YES | CURRENT_TIMESTAMP | - | 更新时间 |

---

## 二、订单与支付模块

### 2.1 order（订单表）

用户订单信息表，记录购买套餐的订单。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 订单ID |
| order_no | varchar(64) | NO | - | UNI | 订单编号 |
| user_id | varchar(64) | NO | - | MUL | 用户ID |
| package_id | bigint | NO | - | - | 套餐ID |
| amount | decimal(10,2) | NO | - | - | 订单金额 |
| pay_amount | decimal(10,2) | YES | 0.00 | - | 实际支付金额 |
| pay_status | tinyint(1) | YES | 0 | MUL | 支付状态:0-未支付,1-已支付,2-已取消,3-已退款 |
| pay_time | datetime | YES | NULL | - | 支付时间 |
| wx_transaction_id | varchar(64) | YES | NULL | - | 微信交易ID |
| wx_out_trade_no | varchar(64) | YES | NULL | - | 微信订单号 |
| create_time | datetime | YES | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | datetime | YES | CURRENT_TIMESTAMP | - | 更新时间 |

### 2.2 subscription_package（订阅套餐表）

会员订阅套餐配置表。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 套餐ID |
| name | varchar(100) | NO | - | - | 套餐名称 |
| description | varchar(500) | YES | NULL | - | 套餐描述 |
| price | decimal(10,2) | NO | - | - | 价格 |
| duration | int | NO | - | - | 有效期(天) |
| status | tinyint(1) | YES | 1 | - | 状态:1-启用,0-禁用 |
| sort | int | YES | 0 | - | 排序 |
| create_time | datetime | YES | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | datetime | YES | CURRENT_TIMESTAMP | - | 更新时间 |

---

## 三、聊天功能模块

### 3.1 chat_message（聊天消息表）

存储用户与AI智能体的聊天记录。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 主键ID |
| user_id | bigint | NO | - | MUL | 用户ID |
| chat_id | varchar(128) | NO | - | MUL | 聊天会话ID |
| agent_id | varchar(128) | NO | - | MUL | 智能体ID |
| content | text | NO | - | - | 消息内容 |
| message_type | tinyint | YES | 1 | - | 消息类型：1-文本，2-图片 |
| direction | tinyint | NO | - | - | 消息方向：1-用户发送，2-智能体回复 |
| created_at | datetime | YES | CURRENT_TIMESTAMP | - | 创建时间 |
| updated_at | datetime | YES | CURRENT_TIMESTAMP | - | 更新时间 |

### 3.2 avatars（分身表）

数字分身/智能体配置表，存储AI分身的人设和配置信息。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | varchar(36) | NO | - | PRI | 分身ID |
| name | varchar(100) | NO | - | - | 分身名称 |
| description | varchar(500) | YES | NULL | - | 分身描述 |
| avatar_url | varchar(255) | YES | NULL | - | 分身头像URL |
| create_time | datetime | YES | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | datetime | YES | CURRENT_TIMESTAMP | - | 更新时间 |
| status | varchar(20) | YES | training | - | 状态：active-活跃 training-训练中 inactive-非活跃 |
| file_key_a | varchar(256) | YES | NULL | - | 文件密钥A |
| file_key_b | varchar(256) | YES | NULL | - | 文件密钥B |
| personality | text | YES | NULL | - | 数字分身的人设，通过file_key_a和file_key_b对应的文本内容调用百炼大模型生成 |
| user_id | varchar(128) | YES | NULL | - | 用户id |
| config | varchar(4000) | YES | NULL | - | 配置项 |

---

## 四、保险产品模块

### 4.1 insurance_product（保险产品表）

保险产品信息表，存储各类保险产品详情。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 产品ID |
| product_name | varchar(100) | NO | - | - | 产品名称 |
| product_code | varchar(50) | NO | - | UNI | 产品代码 |
| product_type | varchar(50) | YES | NULL | - | 产品类型 |
| company_name | varchar(100) | YES | NULL | - | 保险公司 |
| min_amount | decimal(15,2) | YES | 0.00 | - | 最低保额 |
| max_amount | decimal(15,2) | YES | 0.00 | - | 最高保额 |
| min_premium | decimal(15,2) | YES | 0.00 | - | 最低保费 |
| max_premium | decimal(15,2) | YES | 0.00 | - | 最高保费 |
| coverage | varchar(4000) | YES | NULL | - | 保障范围 |
| description | varchar(1000) | YES | NULL | - | 产品描述 |
| details | text | YES | NULL | - | 产品详情 |
| image_url | varchar(255) | YES | NULL | - | 产品图片 |
| status | tinyint | YES | 1 | - | 产品状态：0-下架 1-上架 |
| create_time | datetime | YES | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | datetime | YES | CURRENT_TIMESTAMP | - | 更新时间 |
| tags | varchar(500) | YES | NULL | - | 产品标签：关键字，中文 |
| age_range | varchar(100) | YES | NULL | - | 投保年龄 |
| insurance_period | varchar(100) | YES | NULL | - | 保险期间 |
| payment_period | varchar(100) | YES | NULL | - | 交费期间 |
| waiting_period | varchar(100) | YES | NULL | - | 等待期 |
| exclusions | text | YES | NULL | - | 责任免除 |
| cooling_off_period | varchar(100) | YES | NULL | - | 犹豫期 |
| surrender_terms | text | YES | NULL | - | 退保说明 |
| extend_info | json | YES | NULL | - | 其他必要信息，map格式 |

---

## 五、权限管理模块

### 5.1 role（角色表）

系统角色定义表。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 角色ID |
| role_name | varchar(50) | NO | - | - | 角色名称 |
| role_code | varchar(50) | NO | - | UNI | 角色标识 |
| description | varchar(255) | YES | NULL | - | 角色描述 |
| create_time | datetime | YES | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | datetime | YES | CURRENT_TIMESTAMP | - | 更新时间 |
| status | tinyint | YES | 1 | - | 状态：0-禁用 1-启用 |

### 5.2 permission（权限表）

系统权限定义表。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 权限ID |
| permission_name | varchar(50) | NO | - | - | 权限名称 |
| permission_code | varchar(50) | NO | - | UNI | 权限标识 |
| description | varchar(255) | YES | NULL | - | 权限描述 |
| url | varchar(255) | YES | NULL | - | URL地址 |
| method | varchar(10) | YES | NULL | - | 请求方法 |
| parent_id | bigint | YES | 0 | - | 父级ID |
| sort | int | YES | 0 | - | 排序 |
| create_time | datetime | YES | CURRENT_TIMESTAMP | - | 创建时间 |
| update_time | datetime | YES | CURRENT_TIMESTAMP | - | 更新时间 |
| status | tinyint | YES | 1 | - | 状态：0-禁用 1-启用 |

### 5.3 role_permission（角色权限关联表）

角色与权限的多对多关联表。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 主键ID |
| role_id | bigint | NO | - | MUL | 角色ID |
| permission_id | bigint | NO | - | - | 权限ID |

---

## 六、文件管理模块

### 6.1 upload_file（文件上传表）

文件上传记录表，支持文档解析功能。

| 字段名 | 类型 | 可空 | 默认值 | 键 | 说明 |
|--------|------|------|--------|-----|------|
| id | bigint | NO | - | PRI | 文件ID |
| user_id | bigint | NO | - | MUL | 用户ID |
| original_name | varchar(255) | NO | - | - | 文件原始名称 |
| storage_name | varchar(255) | NO | - | UNI | 文件存储名称（OSS中的key） |
| file_type | varchar(20) | NO | - | MUL | 文件类型：pdf, doc, docx, mp3, wav |
| file_size | bigint | NO | - | - | 文件大小（字节） |
| oss_path | varchar(500) | YES | NULL | - | OSS存储路径 |
| parse_status | tinyint | YES | 0 | MUL | 解析状态：0-未解析, 1-解析中, 2-解析成功, 3-解析失败 |
| parsed_text | text | YES | NULL | - | 解析后的文本内容 |
| parse_error | varchar(500) | YES | NULL | - | 解析失败原因 |
| create_time | datetime | YES | CURRENT_TIMESTAMP | MUL | 创建时间 |
| update_time | datetime | YES | CURRENT_TIMESTAMP | - | 更新时间 |
| parse_time | datetime | YES | NULL | - | 解析完成时间 |

---

## 表关系说明

```
user (1) -----> (N) member_subscription       用户的订阅记录
user (1) -----> (N) member_subscription_record 用户的订阅历史
user (1) -----> (N) order                     用户的订单
user (1) -----> (N) chat_message              用户的聊天记录
user (1) -----> (N) upload_file               用户上传的文件
user (N) -----> (1) role                      用户的角色

subscription_package (1) -----> (N) order     套餐对应的订单

role (1) -----> (N) role_permission           角色的权限关联
permission (1) -----> (N) role_permission     权限的角色关联

avatars (1) -----> (N) chat_message           分身/智能体的聊天记录
```

---

## 状态码说明

### 通用状态
- `0` - 禁用/下架/未支付/无效/未解析
- `1` - 启用/上架/已支付/有效

### 支付状态 (pay_status)
- `0` - 未支付
- `1` - 已支付
- `2` - 已取消
- `3` - 已退款

### 会员等级 (member_level)
- `0` - 普通用户
- `1` - 月度会员
- `2` - 季度会员
- `3` - 年度会员

### 消息方向 (direction)
- `1` - 用户发送
- `2` - 智能体回复

### 文件解析状态 (parse_status)
- `0` - 未解析
- `1` - 解析中
- `2` - 解析成功
- `3` - 解析失败

### 分身状态 (avatars.status)
- `active` - 活跃
- `training` - 训练中
- `inactive` - 非活跃

---

*文档生成时间：2024年*
