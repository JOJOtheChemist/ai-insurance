# Insurance Search Tools Implementation Plan

## 1. Goal
Implement a PostgreSQL-based search system for insurance products that supports:
1.  **Hybrid Search**: Full-text search across Name, Description, and deep JSON content.
2.  **Deep & Context-Award Retrieval**: Ability to extract relevant JSON snippets (saving tokens) or full object details.
3.  **Structured Filtering**: Numerical and categorical filtering (Age, Sum Assured).

## 2. User Review Required
> [!IMPORTANT]
> **Database Migration Required**: This plan requires installing the `pg_trgm` extension and adding GIN indexes to the `insurance_product` table. Ensure the database user has permissions to create extensions and indexes.

## 3. Proposed Changes

### Database Layer
#### [MODIFY] [init_db.sql](file:///Users/yeya/Documents/HBuilderProjects/ai保险-产品详情页/kode-sdk/开发工具计划/backend/init_db.sql) (or similar init script)
- Enable `pg_trgm` extension.
- Add GIN indexes for `extend_info` and `description`.
- Add `jsonb_search_snippet` function (PL/pgSQL) to handle the snippet extraction logic ideally in DB to save bandwidth, or plan to do it in Python if logic is too complex for PL/pgSQL. *Decision: Start with Python-side extraction for easier iteration, move to PL/pgSQL if performance is an issue.*

### Backend (FastAPI)
#### [NEW] [search_service.py](file:///Users/yeya/Documents/HBuilderProjects/ai保险-产品详情页/kode-sdk/开发工具计划/backend/services/search_service.py)
- Implement `search_products(query, snippet_level)`:
    - SQL query with `OR` logic for Name/Desc/JSON.
    - Post-processing: Iterate results. If match is in JSON, traverse and extract snippet based on `snippet_level` (Return containing object).
- Implement `inspect_product(id, fields)`:
    - Retreive full JSON or specific sub-paths.
- Implement `filter_products(filters)`:
    - Dynamic SQL construction for ranges/types.

#### [MODIFY] [main.py](file:///Users/yeya/Documents/HBuilderProjects/ai保险-产品详情页/kode-sdk/开发工具计划/backend/main.py)
- Expose endpoints: `/api/tools/search`, `/api/tools/inspect`, `/api/tools/filter`.

### SDK / Agent Layer
#### [NEW] [tools/search.ts](file:///Users/yeya/Documents/HBuilderProjects/ai保险-产品详情页/kode-sdk/src/tools/insurance_search/index.ts)
- Define `insurance_search` tool.
- Prompt: "Use this to find products. Returns short snippets. Use 'inspect' for more details."

#### [NEW] [tools/inspect.ts](file:///Users/yeya/Documents/HBuilderProjects/ai保险-产品详情页/kode-sdk/src/tools/insurance_inspect/index.ts)
- Define `insurance_inspect` tool.

#### [NEW] [tools/filter.ts](file:///Users/yeya/Documents/HBuilderProjects/ai保险-产品详情页/kode-sdk/src/tools/insurance_filter/index.ts)
- Define `insurance_filter` tool.

## 4. Verification Plan

### Automated Tests
- Create `backend/test_search.py`:
    - **Test 1**: Context Length. Insert a long JSON. Search for a keyword. Verify returned snippet is structurally complete (e.g. whole object) but not the entire file.
    - **Test 2**: Search Scope. Insert 3 products (Match Name, Match Desc, Match JSON). Search for keyword. Verify all 3 returned.
    - **Test 3**: Filter. Verify age filtering.

### Manual Verification
- Run the test script and output results to `test_tools_results.txt`.
