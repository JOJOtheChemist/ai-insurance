# AI 保险搜索工具后端接入方案

> 目的：确定 `kode-sdk` 的搜索工具应该如何访问 PostgreSQL，兼顾上下文节省、易维护和部署便利。

## 1. 两种架构选项

| 方案 | 描述 | 优势 | 风险 & 成本 |
| --- | --- | --- | --- |
| A. `kode-sdk` 直接连 PG | 在工具执行器里引入 PG 客户端（`pg`/`psycopg2`），由 Node/TS 代码直接执行 SQL。 | - 调用链最短，延迟低<br>- 可在同进程内共享缓存 | - `kode-sdk` 是面向 Agent 的通用服务，侵入数据库凭据 ↑ 安全风险<br>- 需要为 Node 进程部署数据库驱动、连接池与重试机制<br>- 难以复用 FastAPI 里已有的业务查询逻辑与测试脚本 |
| B. FastAPI 统一封装，再由 `kode-sdk` 调用 HTTP API ✅ | 复用 `insurance-product-viewer/backend/main.py` 中的 `/api/tools/search|inspect|filter`，`kode-sdk` 工具通过 HTTP 请求这些接口。 | - 复用现有 FastAPI 实现（已连 PG、写好 SQL 与 `test_tools.sh`）<br>- `kode-sdk` 只需配置 BASE_URL + Token，不暴露 DB 密钥<br>- 更容易横向扩展或替换实现（紧急时可直接在后端限流/缓存） | - 多一跳 HTTP 但延迟可控（同机内 <5ms）<br>- FastAPI 需要常驻运行 |

**结论**：选方案 B。FastAPI 既是业务后端也是 Agent 工具的统一入口，可以复用 `/api/products`/`/api/rates` 等已有接口，便于团队在一个地方管理 SQL、安全、索引和测试。

## 2. 推荐落地步骤

1. **保持 FastAPI 为单一数据访问层**  
   - 后端代码：`insurance-product-viewer/backend/main.py`（端口 8000）。  
   - PostgreSQL 链接参数：由 `DB_HOST / DB_NAME / DB_USER / DB_PASSWORD / DB_PORT` 控制，可按 `START_GUIDE.md` 中的 `psql` 命令检查连接。
2. **在 `kode-sdk` 注册 HTTP 工具**  
   - 目录建议：`kode-sdk/src/tools/insurance_search|inspect|filter`.  
   - 工具执行器内部只负责 `fetch('http://localhost:8000/api/tools/...')` 并把响应结果压缩成 Agent 需要的 JSON，保持和 `search_notes` 工具类似的结构。
3. **环境配置**  
   - 在 `server/.env` 或部署平台配置 `INSURANCE_API_BASE_URL=http://localhost:8000`，工具读取后拼接请求 URL。  
   - 若 FastAPI 需要鉴权，可在工具内加入 `Authorization` 头，避免泄露数据库账号。
4. **测试与回归**  
   - FastAPI 端已有 `backend/test_tools.sh`，运行它验证 PG 查询逻辑。  
   - `kode-sdk` 端编写 Jest/ts-node 集成测试，使用 mock server 或本地 8000 实例确认 tool schema 与响应格式。

## 3. 为什么不让 `kode-sdk` 直连 PG？

1. **安全与权限隔离**：FastAPI 可加鉴权、审计或速率限制；如果直接在 Agent 进程里放 PG 凭据，任何工具 bug 都可能导致误删/泄露。
2. **业务逻辑复用**：搜索、过滤、费率计算等 SQL 已在 FastAPI 里实现，继续在 Node 里重写会造成双份代码与测试。
3. **部署与运维**：FastAPI 有独立的 `START_GUIDE.md`、`backend/test_tools.sh`、日志与监控。如果日后要扩展（例如加缓存、写入其他数据源），只需动后端。
4. **上下文 & Token 成本控制**：已有接口已经做了 snippet/字段按需返回等优化（详见 `learning_notes/Advanced_Insurance_Search_Implementation.md`），连 PG 自己写 SQL 更容易遗漏这些细节。

## 4. 后续行动项

- [ ] FastAPI 端：补充 PG 索引、完善 `/api/tools/*` 返回格式说明，确保 `test_tools.sh` 通过。
- [ ] `kode-sdk` 端：创建工具定义与注册（Phase 2），将 BASE_URL 配置注入。
- [ ] Agent Prompt：在 System Prompt 中说明“保险相关需求优先调用 insurance_search → inspect → filter 的 API 工具”。
