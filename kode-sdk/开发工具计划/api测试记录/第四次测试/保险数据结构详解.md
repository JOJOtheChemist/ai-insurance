# 保险数据结构与多态性详解

本文档旨在补充 [API工具总结.md](./API工具总结.md)，专门深入解析保险产品的**动态数据结构**，特别是 `coverage` 和 `extend_info` 字段在不同险种下的多态表现。

## 1. 核心字段深度解析 (Deep Dive)

保险产品最核心且最复杂的两个字段如下：

### 1.1 `coverage` (保障责任) — "保什么？"
这是一个 **Map <保障项名称, 条款细则>** 结构。它直接对应保险合同里的“保险责任”章节。
*   **内容**: 具体的赔付触发条件和定义。
*   **特点**: **纯文本字典**。
*   **示例 (意外险)**:
    ```json
    {
      "猝死保险金": "若被保险人发生猝死，给付...",
      "意外骨折医疗": "因意外导致骨折，按比例赔付..."
    }
    ```
*   **示例 (医疗险)**:
    ```json
    {
      "一般门急诊": "等待期后，门急诊费用..."
    }
    ```

### 1.2 `extend_info` (扩展信息) — "怎么赔 & 多少钱？"
这是一个其大无比的 **“杂物箱” (JSON Object)**，存放所有**结构化、可视化**所需的元数据。它的 Key 会根据险种不同而完全不同（多态性）。

**通用字段**:
*   `highlights` (List): 产品亮点标签（如“最高保额”、“等待期”）。
*   `table_data` (Object): 费率表或利益演示表数据。
*   `theme_color` (String): UI 渲染用的主题色。

**特有字段 (Polymorphic)**:
*   **重疾险 (`illness_features`)**: 包含轻/中/重症的分组列表、赔付比例。
*   **医疗险 (`medical_features`)**: 包含免赔额、报销比例、就医范围。
*   **寿险 (`life_features`)**: 包含现金价值表、减保规则。

**Agent 策略**:
正是因为 `extend_info` 太杂太深，Agent **必须**结合 `view=summary` 先看它里面有什么（比如是 `medical_features` 还是 `life_features`），然后再决定去挖哪个细节。

---

## 2. 关于字段语义 (Key Semantics)

**Agent 拿到 Key 之后，怎么知道这个 Key 是干嘛的？**

目前的设计采用了 **"语义化命名 (Semantic Naming)"** 策略，即变量名本身就是描述。

*   **机制**:
    *   API 返回: `["illness_features", "waiting_period"]`
    *   Agent 推理: "`illness_features` 肯定是病种相关，`waiting_period` 肯定是等待期。"
*   **局限性**:
    *   目前为了追求 token 效率，未返回 `key: description` 字典。
    *   依赖 LLM 对标准保险术语（如 `deductible`, `quota`）的自然理解能力。

---

## 3. Agent 视角：Summary 模式下的真实返回

以下是 Agent 在调用 `inspect(..., view="summary")` 时 **实际看到** 的返回内容。Agent Chính是靠这些 Key 来判断下一步查什么的。

### 示例 1：定期寿险 (ID: 20)
**Request**: `view="summary"`
**Response**:
```json
{
  "extend_info_keys": [
    "highlights",
    "table_data",
    "theme_color",
    "life_features"  <-- Agent 看到这个词，决定下一步查 life_features
  ]
}
```

### 示例 2：重疾险 (ID: 33)
**Request**: `view="summary"`
**Response**:
```json
{
  "extend_info_keys": [
    "highlights",
    "coverage_list",
    "theme_color",
    "illness_features" <-- Agent 看到这个词，决定下一步查 illness_features
  ]
}
```

### 示例 3：高端医疗险 (ID: 43)
**Request**: `view="summary"`
**Response**:
```json
{
  "extend_info_keys": [
    "highlights",
    "medical_features", <-- Agent 看到这个词，决定下一步查 medical_features
    "theme_color"
  ]
}
```

**总结**: 
虽然顶层都叫 `extend_info`，但 Agent 通过 summary 模式看到的 **Key 列表是不一样的**。
*   看到 `life_features` -> 它是寿险，我要查现金价值。
*   看到 `medical_features` -> 它是医疗险，我要查免赔额。

---

## 4. Agent 视角：下一步查具体内容 (Drill Down)

Agent 在 Summary 模式下“看到”了关键 Key 后，会发起**第二次精准查询**。以下是真实返回的内容：

### 示例 1：定期寿险 (ID: 20)
**Agent 思考**: "看到了 `life_features`，我想知道具体的投保年龄和身故赔付规则。"
**Request**: `fields="extend_info.life_features"`
**Response**:
```json
{
  "extend_info.life_features": {
    "basic_rules": {
        "age_limit": "男18-45岁 女18-50岁",
        "payment_period": "10/20年",
        "insurance_period": "至65岁"
    },
    "death_disability": {
        "death_payout": "100%基本保险金额",
        "disability_payout": "100%基本保险金额"
    }
  }
}
```

### 示例 2：重疾险 (ID: 33)
**Agent 思考**: "看到了 `illness_features`，我想确认轻症包含哪些病，赔多少。"
**Request**: `fields="extend_info.illness_features"`
**Response**:
```json
{
  "extend_info.illness_features": {
    "medium_light_illness": {
        "light_payout": "30%",
        "light_count": "40种",
        "waiver": "确诊豁免后续保费",
        "light_list": [
            "极早期恶性肿瘤或恶性病变",
            "轻度急性心肌梗死",
            "..."
        ]
    }
  }
}
```

### 示例 3：高端医疗险 (ID: 43)
**Agent 思考**: "看到了 `medical_features`，我想看它的住院报销规则。"
**Request**: `fields="extend_info.medical_features"`
**Response**:
```json
{
  "extend_info.medical_features": {
    "hospitalization": {
        "reimbursement_rate": "约定比例",
        "pre_post_hospitalization": "门急诊含"
    },
    "special_coverage": {
        "designated_medical_equipment": "特定医疗含眼科/心理"
    }
  }
}
```

**终极结论**:
通过 **Summary (看目录)** -> **Drill Down (查细节)** 这两步走：
1.  Agent 即使面对结构完全不同的产品，也能从容应对。
2.  避免了一次性把几千字的病种列表扔进 Context，只在需要时才提取，极其高效。
