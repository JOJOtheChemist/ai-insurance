# 积分系统设计方案

## 一、积分消耗规则

### 混合计费模型

```
积分消耗 = 基础费用(1积分) + Token消耗(每1000 token 扣 1 积分)
```

### 消耗示例

| 场景 | Token 估算 | 积分消耗 |
|------|-----------|---------|
| 简单问候 | ~50 | 1 积分 |
| 普通咨询 | ~500 | 1 积分 |
| 复杂方案分析 | ~2000 | 3 积分 |
| 多轮深度对话 | ~5000 | 6 积分 |

### Token 估算规则

- 1 中文字 ≈ 2 tokens
- 1 英文词 ≈ 1 token
- 统计开销极低（<1ms），可忽略不计

---

## 二、积分套餐定价

### 方案 A：低成本模型（DeepSeek / 国产模型）

| 套餐 | 价格 | 积分 | 约使用次数 | 单次成本 |
|-----|------|-----|-----------|---------|
| 体验包 | ¥9.9 | 100 积分 | ~50-100次 | ¥0.1-0.2 |
| 标准包 | ¥29.9 | 500 积分 | ~250-500次 | ¥0.06-0.12 |
| 专业包 | ¥99 | 2000 积分 | ~1000-2000次 | ¥0.05-0.1 |

**利润空间：60-80%**

### 方案 B：中成本模型（GPT-4o）

| 套餐 | 价格 | 积分 | 约使用次数 |
|-----|------|-----|-----------|
| 体验包 | ¥19.9 | 100 积分 | ~30-50次 |
| 标准包 | ¥59 | 400 积分 | ~120-200次 |
| 专业包 | ¥199 | 1800 积分 | ~600-900次 |

**利润空间：40-60%**

---

## 三、运营策略

1. **新用户福利**：首次注册赠送 50-100 积分
2. **邀请奖励**：邀请好友注册双方各得 30 积分
3. **月度订阅**：¥49/月 无限使用（适合高频用户）

---

## 四、技术实现要点

### 后端

1. 用户表增加 `balance` 字段（积分余额）
2. 创建 `credit_transactions` 表记录充值/消费流水
3. 每次 AI 对话完成后扣除积分
4. 积分不足时返回提示，引导充值

### 前端

1. 个人中心显示积分余额
2. 充值弹窗支持套餐选择
3. 对话界面显示本次消耗积分

---

## 五、后端实现详细设计

### 5.1 数据库模型

#### User 模型扩展 (修改 `models/user.py`)

```python
# 新增字段
balance = Column(Integer, default=100)  # 积分余额，新用户赠送100积分
```

#### CreditTransaction 模型 (新建 `models/credit_transaction.py`)

```python
class CreditTransaction(Base):
    """积分交易流水"""
    __tablename__ = "credit_transactions"

    id = Column(BigInteger, primary_key=True, index=True)
    user_id = Column(BigInteger, ForeignKey("users.id"), nullable=False, index=True)
    
    # 交易类型: topup(充值), consume(消费), bonus(赠送), refund(退款)
    transaction_type = Column(String(20), nullable=False)
    
    # 金额 (正数为增加，负数为扣除)
    amount = Column(Integer, nullable=False)
    
    # 交易后余额
    balance_after = Column(Integer, nullable=False)
    
    # 描述/备注
    description = Column(String(255))
    
    # 关联的会话ID (消费时记录)
    session_id = Column(String(100), nullable=True)
    
    # Token 消耗详情 (消费时记录)
    token_count = Column(Integer, nullable=True)
    
    create_time = Column(DateTime(timezone=True), server_default=func.now())
```

### 5.2 积分计算服务 (新建 `services/credit_service.py`)

```python
class CreditService:
    
    @staticmethod
    def estimate_tokens(text: str) -> int:
        """估算文本的 token 数量"""
        # 简化估算：中文字符*2 + 英文单词数
        chinese_chars = sum(1 for c in text if '\u4e00' <= c <= '\u9fff')
        english_words = len(text.split()) - chinese_chars
        return chinese_chars * 2 + max(english_words, 0)
    
    @staticmethod
    def calculate_credits(input_tokens: int, output_tokens: int) -> int:
        """计算本次对话消耗的积分"""
        total_tokens = input_tokens + output_tokens
        # 基础费用1积分 + 每1000 token 1积分
        return 1 + (total_tokens // 1000)
    
    @staticmethod
    def deduct_credits(db, user_id: int, amount: int, session_id: str = None, 
                       token_count: int = None, description: str = "AI对话消费"):
        """扣除用户积分"""
        user = db.query(User).filter(User.id == user_id).first()
        if not user:
            raise HTTPException(status_code=404, detail="用户不存在")
        
        if user.balance < amount:
            raise HTTPException(status_code=402, detail="积分不足，请充值")
        
        # 扣除积分
        user.balance -= amount
        
        # 记录流水
        transaction = CreditTransaction(
            user_id=user_id,
            transaction_type="consume",
            amount=-amount,
            balance_after=user.balance,
            description=description,
            session_id=session_id,
            token_count=token_count
        )
        db.add(transaction)
        db.commit()
        
        return {"success": True, "balance": user.balance, "deducted": amount}
    
    @staticmethod
    def topup_credits(db, user_id: int, amount: int, description: str = "积分充值"):
        """充值积分"""
        user = db.query(User).filter(User.id == user_id).first()
        if not user:
            raise HTTPException(status_code=404, detail="用户不存在")
        
        user.balance += amount
        
        transaction = CreditTransaction(
            user_id=user_id,
            transaction_type="topup",
            amount=amount,
            balance_after=user.balance,
            description=description
        )
        db.add(transaction)
        db.commit()
        
        return {"success": True, "balance": user.balance, "added": amount}
```

### 5.3 API 路由 (新建 `routers/credits.py`)

```python
router = APIRouter(prefix="/credits", tags=["积分管理"])

@router.get("/balance")
async def get_balance(user_id: int, db: Session = Depends(get_db)):
    """获取用户积分余额"""
    user = db.query(User).filter(User.id == user_id).first()
    if not user:
        raise HTTPException(status_code=404, detail="用户不存在")
    return {"balance": user.balance}

@router.post("/deduct")
async def deduct_credits(
    user_id: int,
    amount: int,
    session_id: str = None,
    token_count: int = None,
    db: Session = Depends(get_db)
):
    """扣除积分"""
    return CreditService.deduct_credits(db, user_id, amount, session_id, token_count)

@router.post("/topup")
async def topup_credits(
    user_id: int,
    amount: int,
    description: str = "积分充值",
    db: Session = Depends(get_db)
):
    """充值积分"""
    return CreditService.topup_credits(db, user_id, amount, description)

@router.get("/transactions")
async def get_transactions(
    user_id: int,
    limit: int = 20,
    offset: int = 0,
    db: Session = Depends(get_db)
):
    """获取积分交易记录"""
    transactions = db.query(CreditTransaction).filter(
        CreditTransaction.user_id == user_id
    ).order_by(CreditTransaction.create_time.desc()).offset(offset).limit(limit).all()
    
    return {
        "transactions": [
            {
                "id": t.id,
                "type": t.transaction_type,
                "amount": t.amount,
                "balance_after": t.balance_after,
                "description": t.description,
                "time": t.create_time.strftime("%Y-%m-%d %H:%M")
            }
            for t in transactions
        ]
    }
```

### 5.4 集成到 main.py

```python
from routers import credits

app.include_router(credits.router, prefix="/api/v1")
```

---

## 六、验证计划

### 自动化测试

```bash
# 测试积分余额查询
curl http://localhost:8000/api/v1/credits/balance?user_id=1

# 测试积分扣除
curl -X POST "http://localhost:8000/api/v1/credits/deduct?user_id=1&amount=5&session_id=test123"

# 测试积分充值
curl -X POST "http://localhost:8000/api/v1/credits/topup?user_id=1&amount=100"

# 查询交易记录
curl http://localhost:8000/api/v1/credits/transactions?user_id=1
```

### 预期结果

1. 新用户默认有 100 积分
2. 扣除积分后余额正确减少
3. 充值后余额正确增加
4. 交易记录正确保存
