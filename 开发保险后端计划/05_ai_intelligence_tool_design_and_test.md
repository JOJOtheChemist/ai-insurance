# AI 智能更新工具设计与测试方案

本文档汇总了 `update_client_intelligence` 工具的设计思路及其验证结果。

## 1. 工具设计方案 (Design Scheme)

### 1.1 核心理念：以对话为中心，多实体提取
**“对话是流，客户是存量”**。
- **对话系统独立**: 保持原有的 `.kode` 文件存储系统，后端数据库仅记录摘要与关联。
- **一对多/多对多关联**: 一个对话 Session 可以产生、更新多个 Client 档案。AI 在对话中识别出不同的主体（如：给王总做方案时提到他太太张女士也有需求），可同时或先后触发不同实体的更新。
- **智能链路**: 每一个 Client 的变更历史都会记录其来源的 `sessionId`，从而实现“从客户看相关对话”、“从对话看涉及客户”的双向溯源。

### 1.2 工具定义
- **工具名称**: `update_client_intelligence`
- **主要参数**:
    - `targetClient` (新): 指定本次更新的目标客户标识（如姓名或 ID）。
    - `sessionId`: 必填，用于记录数据来源。
    - `profileUpdates`: 针对该主体的画像更新。
    - `familyMembers`: 该主体相关的家庭成员。
    - `followUpSummary`: 本次对话中关于该主体的关键结论。

### 1.3 后端分发与冲突处理
- **多主体分发**: 如果 AI 在一次工具调用中涉及多个客户，后端按 `targetClient` 进行拆解存储。
- **增量合并**: 仅对识别到的差异部分进行 Patch。

---

## 2. 工具测试结果 (Test Results)

(以下内容在测试执行后自动生成/更新)

### 2.1 测试用例：模拟多主体并行提取
**场景**: AI 在同一个 Session (`session-multi-001`) 中先后识别到两位不同的客户——“王总”和“李女士”。

**第一次调用 (更新王总)**:
- `targetClient`: "王总(多主体)"
- `profileUpdates`: 姓名、年龄(45)、风险(加班)
- `followUpSummary`: "王总提到自己工作很忙。"

**第二次调用 (更新李女士)**:
- `targetClient`: "李女士(多主体)"
- `profileUpdates`: 姓名、年龄(42)、需求(养老金)
- `followUpSummary`: "顺便咨询了李女士的养老问题。"

### 2.2 执行结果
- **API 响应**:
    - 王总: `HTTP 200`, `client_id: 1`
    - 李女士: `HTTP 200`, `client_id: 2`
- **关联关系**: 
    - 两位客户的 `FollowUp` 记录中，`session_id` 均为 `session-multi-001`。
    - 后端 `session_client_links` 表中已自动建立两条关联记录。

### 2.3 结论
**验证通过**。系统成功支持“以对话为中心”的多实体架构。AI 工具已能够根据 `targetClient` 智能分发更新指令，确保同一段对话能同时服务多个客户档案。
